<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drug Focus - Search Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2196f3;
      --primary-dark: #1976d2;
      --text-color: #333;
      --light-gray: #f4f7fa;
      --white: #ffffff;
      --border-radius: 8px;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--light-gray);
      direction: rtl;
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Cairo', sans-serif;
    }

    /* Header Styles */
    header {
      background-color: var(--white);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 0;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary-color);
      transition: transform 0.3s ease;
    }

    .logo-img:hover {
      transform: scale(1.1);
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      text-decoration: none;
    }

    .nav-links a {
      color: var(--text-color);
      text-decoration: none;
      margin-left: 20px;
      font-size: 16px;
      transition: color 0.3s ease;
    }

    .nav-links a:hover {
      color: var(--primary-dark);
    }

    /* Main Content Styles */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 120px 20px 80px;
    }

    .container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      gap: 20px;
      padding: 20px;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .filters {
      width: 300px;
      background-color: var(--white);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .filters h3 {
      margin: 0 0 15px;
      font-size: 20px;
      color: var(--primary-color);
    }

    .filters label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
      color: var(--text-color);
    }

    .filters input[type="text"],
    .filters input[type="number"],
    .filters select {
      width: 100%;
      height: 40px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 14px;
      line-height: 20px;
      box-sizing: border-box;
      transition: border-color 0.3s;
      direction: rtl;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .filters input[type="text"]:focus,
    .filters input[type="number"]:focus,
    .filters select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .filters input[type="range"] {
      width: 100%;
      accent-color: var(--primary-color);
    }

    .filters .price-display {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }

    .results {
      flex: 1;
      background-color: var(--white);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .sort-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding: 10px;
      background: #f7f7f7;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      height: 60px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .sort-section label {
      font-weight: 500;
      color: var(--text-color);
      margin: 0;
      padding: 0;
      font-size: 15px;
    }

    .sort-section select {
      flex: 1;
      height: 60px;
      padding: 10px 35px 10px 10px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 15px;
      background-color: #f7f7f7;
      color: #555;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/><path d='M0 0h24v24H0z' fill='none'/></svg>");
      background-repeat: no-repeat;
      background-position: left 10px center;
      min-width: 200px;
    }

    .sort-section select:focus {
      outline: none;
    }

    .drug-item, .header {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr;
      gap: 20px;
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .drug-item:hover {
      background-color: #f0f0f0;
      transform: translateX(-5px);
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .drug-item:last-child {
      border-bottom: none;
    }

    .drug-item strong, .drug-item span {
      font-weight: normal;
      color: var(--text-color);
      text-align: right;
    }

    .drug-item .concentration {
      display: inline-block;
      text-align: right;
    }

    .error-message {
      color: #d32f2f;
      text-align: center;
      padding: 15px;
      background-color: #ffebee;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }

    .header {
      font-weight: bold;
      background-color: #f0f0f0;
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr 1fr 1fr;
      padding: 15px;
      border-bottom: 2px solid #ddd;
    }

    .header span {
      text-align: right;
    }

    /* Footer Styles */
    footer {
      background-color: var(--primary-color);
      color: var(--white);
      padding: 20px 0;
      text-align: center;
    }

    .footer-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .footer-links a {
      color: var(--white);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: #e0e0e0;
    }

    .copyright {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Language-specific fonts */
    *[lang="ar"], html[lang="ar"] body, .container, .filters, .results, .drug-item, .header, .sort-section {
      font-family: 'Cairo', sans-serif;
    }

    *[lang="en"], .drug-item[lang="en"] {
      font-family: 'Roboto', sans-serif;
      direction: ltr;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .filters {
        width: 100%;
      }

      .sort-section {
        flex-direction: column;
        align-items: flex-start;
        height: auto;
      }

      .sort-section select {
        width: 100%;
        height: 40px;
      }

      .drug-item, .header {
        grid-template-columns: 1fr;
        text-align: right;
      }

      .drug-item span, .header span {
        margin-bottom: 5px;
      }

      .drug-item .concentration {
        text-align: right;
      }
    }
  </style>
</head>
<body onload="showResults()">
  <!-- Header Section -->
  <header>
    <div class="header-container">
      <div class="logo-container">
        <img src="logoo.png" alt="Drug Focus Logo" class="logo-img">
        <a href="#" class="logo-text">Drug Focus</a>
      </div>
      <nav class="nav-links">
        <a href="#">الصفحة الرئيسية</a>
        <a href="search.html" onclick="console.log('Navigating to search.html')">رجوع إلى البحث</a>
        <a href="#">عن الموقع</a>
        <a href="#">اتصل بنا</a>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <div class="container" id="searchResults">
      <div class="filters">
        <h3 lang="ar">تصفية النتائج</h3>
        <label for="manufacturer" lang="ar">الشركة المصنعة:</label>
        <input type="text" id="manufacturer" placeholder="مثلاً MUP" lang="ar">
        <label for="concentration" lang="ar">التركيز:</label>
        <input type="text" id="concentration" placeholder="مثلاً 20 مجم" oninput="validateConcentration(this)" lang="ar">
        <label for="form" lang="ar">الشكل الصيدلي:</label>
        <select id="form" lang="ar">
          <option value="">اختر الشكل الصيدلي</option>
          <option value="أقراص">أقراص</option>
          <option value="فيال">فيال</option>
          <option value="كبسولات">كبسولات</option>
          <option value="محلول">محلول</option>
          <option value="شراب">شراب</option>
        </select>
        <div id="itemCountContainer" style="display: none;">
          <label for="itemCount" id="itemCountLabel" lang="ar">العدد:</label>
          <input type="number" id="itemCount" placeholder="" min="1" lang="ar">
        </div>
        <label for="priceRange" lang="ar">السعر:</label>
        <input type="range" id="priceRange" min="0" max="500" value="500" oninput="document.getElementById('priceValue').textContent = this.value">
        <div class="price-display" lang="ar">حتى <span id="priceValue">500</span> جنيه</div>
      </div>

      <div class="results">
        <div class="sort-section">
          <label for="sortBy" lang="ar">ترتيب حسب:</label>
          <select id="sortBy" lang="ar">
            <option value="name">الأبجدية (الاسم التجاري)</option>
            <option value="price_desc">السعر من الأعلى للأسفل</option>
            <option value="price_asc" selected>السعر من الأسفل للأعلى</option>
          </select>
        </div>
        <div class="header" lang="ar">
          <span>الاسم التجاري</span>
          <span>المادة الفعالة</span>
          <span>التركيز</span>
          <span>الشكل الصيدلي</span>
          <span>السعر</span>
          <span>الشركة المصنعة</span>
        </div>
        <div id="drugList"></div>
      </div>
    </div>
  </main>

  <!-- Footer Section -->
  <footer>
    <div class="footer-container">
      <div class="footer-links">
        <a href="#">الشروط والأحكام</a>
        <a href="#">سياسة الخصوصية</a>
        <a href="#">المساعدة</a>
        <a href="#">الأسئلة الشائعة</a>
      </div>
      <div class="copyright">
        © 2025 Drug Focus. جميع الحقوق محفوظة.
      </div>
    </div>
  </footer>

  <script>
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function toggleTabletCountField() {
      const form = document.getElementById("form").value;
      const itemCountContainer = document.getElementById("itemCountContainer");
      const itemCountInput = document.getElementById("itemCount");
      const itemCountLabel = document.getElementById("itemCountLabel");

      if (form === "أقراص") {
        itemCountContainer.style.display = "block";
        itemCountLabel.textContent = "عدد الأقراص:";
        itemCountInput.placeholder = "مثلاً 14";
        itemCountInput.value = "";
      } else if (form === "كبسولات") {
        itemCountContainer.style.display = "block";
        itemCountLabel.textContent = "عدد الكبسولات:";
        itemCountInput.placeholder = "مثلاً 20";
        itemCountInput.value = "";
      } else {
        itemCountContainer.style.display = "none";
        itemCountLabel.textContent = "العدد:";
        itemCountInput.value = "";
        itemCountInput.placeholder = "";
      }
    }

    function validateConcentration(input) {
      let value = input.value.trim();
      if (value && !/^\d+\.?\d*\s*(ملجم|مل|جرام|وحدة|ميكروجرام|نانوجرام)?$/i.test(value)) {
        input.value = value.replace(/[^0-9\s]/g, '');
        alert("يرجى إدخال التركيز بشكل صحيح (مثل 20 ملجم أو 20)");
      }
    }

    async function fetchDrugs() {
      const urlParams = new URLSearchParams(window.location.search);
      const search = urlParams.get("search") || "";
      const searchType = urlParams.get("searchType") || "trade";
      let concentration = document.getElementById("concentration").value.toLowerCase().trim();
      const manufacturer = document.getElementById("manufacturer").value.toLowerCase();
      const form = document.getElementById("form").value;
      const itemCount = document.getElementById("itemCount").value.trim();
      const price = document.getElementById("priceRange").value;
      const sortBy = document.getElementById("sortBy").value;
      let sortOrder = "ASC";

      if (sortBy === "price_desc") {
        sortOrder = "DESC";
      } else if (sortBy === "price_asc" || sortBy === "name") {
        sortOrder = "ASC";
      }

      const reverseUnitMapping = {
        'ملجم': 'mg',
        'مل': 'ml',
        'جرام': 'gm',
        'ميكروجرام': 'microgram',
        'نانوجرام': 'nanogram',
        'وحدة': 'unit'
      };

      if (concentration) {
        const match = concentration.match(/^(\d+\.?\d*)\s*(ملجم|مل|جرام|وحدة|ميكروجرام|نانوجرام)?$/i);
        if (match) {
          const number = match[1];
          const unit = match[2] || "ملجم";
          concentration = `${number} ${reverseUnitMapping[unit] || 'mg'}`;
        } else {
          concentration += " mg";
        }
      }

      const params = new URLSearchParams();
      if (search) params.append("search", search);
      if (searchType) params.append("searchType", searchType);
      if (concentration) params.append("concentration", concentration);
      if (manufacturer) params.append("manufacturer", manufacturer);
      if (form) {
        params.append("form", form);
        if ((form === "أقراص" || form === "كبسولات") && itemCount && itemCount.trim() !== '') {
          params.append("itemCount", itemCount);
        }
      }
      params.append("price", price);
      params.append("sortBy", sortBy === "price_asc" || sortBy === "price_desc" ? "price" : sortBy);
      params.append("sortOrder", sortOrder);
      params.append("exactMatch", "true");

      try {
        const response = await fetch(`http://localhost:5000/api/drugs?${params}`);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        const drugs = await response.json();
        console.log("API Response:", drugs);
        displayDrugs(drugs);
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("drugList").innerHTML = `<p class="error-message" lang="ar">حدث خطأ: ${error.message}</p>`;
      }
    }

    function displayDrugs(drugs) {
      const drugList = document.getElementById("drugList");
      drugList.innerHTML = "";
      if (drugs.length === 0) {
        drugList.innerHTML = `<p lang="ar">لا توجد نتايج</p>`;
        return;
      }
      drugs.forEach(drug => {
        console.log("Drug Data:", drug);
        const div = document.createElement("div");
        div.className = "drug-item";
        div.dataset.concentration = drug.concentration || "";
        div.dataset.manufacturer = drug.manufacturer || "";
        div.dataset.form = drug.form || "";
        div.dataset.price = drug.price || "";
        const activeIngredient = drug.active_ingredient && drug.active_ingredient.trim() !== "" ? drug.active_ingredient : "غير متوفر";
        
        let concentration = drug.concentration || "غير متوفر";
        const isNameEnglish = /^[a-zA-Z\s]*$/.test(drug.name || "");
        const isActiveIngredientEnglish = /^[a-zA-Z\s]*$/.test(drug.active_ingredient || "");

        div.innerHTML = `
          <span lang="${isNameEnglish ? 'en' : 'ar'}">${drug.name || "غير متوفر"}</span>
          <span lang="${isActiveIngredientEnglish ? 'en' : 'ar'}">${activeIngredient}</span>
          <span class="concentration" lang="ar">${concentration}</span>
          <span lang="ar">${drug.form || "غير متوفر"}</span>
          <span lang="ar">${drug.price ? drug.price.toFixed(2) : "غير متوفر"} جنيه</span>
          <span lang="ar">${drug.manufacturer || "غير متوفر"}</span>
        `;
        div.addEventListener("click", () => {
          window.location.href = `drug_details.html?id=${drug.id}`;
        });
        drugList.appendChild(div);
      });
    }

    function addFilterEvents(fieldId) {
      const field = document.getElementById(fieldId);
      field.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
          fetchDrugs();
        }
      });
      field.addEventListener("blur", () => {
        fetchDrugs();
      });
    }

    document.getElementById("form").addEventListener("change", () => {
      toggleTabletCountField();
      fetchDrugs();
    });

    addFilterEvents("concentration");
    addFilterEvents("itemCount");
    document.getElementById("manufacturer").addEventListener("input", debounce(fetchDrugs, 300));
    document.getElementById("priceRange").addEventListener("input", fetchDrugs);
    document.getElementById("sortBy").addEventListener("change", fetchDrugs);

    function showResults() {
      fetchDrugs();
      toggleTabletCountField();
    }
  </script>
</body>
</html>